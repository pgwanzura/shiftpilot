services:
  traefik:
    image: traefik:v2.10
    container_name: traefik
    command:
      # Global configuration
      - --api.dashboard=true
      - --api.debug=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=shiftpilot-network
      - --providers.docker.watch=true

      # Entrypoints
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.traefik.address=:8080

      # SSL/TLS configuration (optional for local dev)
      - --certificatesresolvers.letsencrypt.acme.email=admin@shiftpilot.com
      - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web

      # Logging
      - --log.level=INFO
      - --accesslog=true

      # Security
      - --ping=true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/letsencrypt:/letsencrypt
    networks:
      - shiftpilot-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      - "traefik.http.routers.traefik-dashboard.entrypoints=traefik"
      # Removed auth for easier development access
    healthcheck:
      test: ["CMD", "traefik", "healthcheck", "--ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  mysql:
    image: mysql:8.0
    container_name: shiftpilot-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: shiftpilot
      MYSQL_USER: shiftpilot
      MYSQL_PASSWORD: password
      MYSQL_CHARSET: utf8mb4
      MYSQL_COLLATION: utf8mb4_unicode_ci
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/conf.d:/etc/mysql/conf.d:ro
    command:
      - --default-authentication-plugin=mysql_native_password
      - --innodb-buffer-pool-size=256M
      - --innodb-log-file-size=128M
    networks:
      - shiftpilot-network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-uroot",
          "-prootpassword",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  redis:
    image: redis:7.2-alpine
    container_name: shiftpilot-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass redispassword
    volumes:
      - redis-data:/data
    networks:
      - shiftpilot-network
    healthcheck:
      test: ["CMD", "redis-cli", "--pass", "redispassword", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  shiftpilot-api:
    build:
      context: ./shiftpilot-api
      dockerfile: Dockerfile
      args:
        - APP_ENV=local
        - CACHE_BREAKER=${CACHE_BREAKER:-0}
    container_name: shiftpilot-api
    restart: unless-stopped
    expose:
      - "80"
    volumes:
      - ./shiftpilot-api:/var/www/html
      - ./shiftpilot-api/storage:/var/www/html/storage
      - ./shiftpilot-api/bootstrap/cache:/var/www/html/bootstrap/cache
    environment:
      APP_ENV: local
      APP_DEBUG: true
      APP_URL: http://api.localhost
      APP_KEY: base64:yo0P0aCjM6Ay4VfbHBNKpb0qfaYvGaR7oF/69wYnM4E=

      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: shiftpilot
      DB_USERNAME: shiftpilot
      DB_PASSWORD: password

      REDIS_HOST: redis
      REDIS_PASSWORD: redispassword
      REDIS_PORT: 6379

      SESSION_DRIVER: redis
      CACHE_DRIVER: redis
      QUEUE_CONNECTION: redis

      SANCTUM_STATEFUL_DOMAINS: frontend.localhost,localhost:3000
      SESSION_DOMAIN: .localhost
      FRONTEND_URL: http://frontend.localhost

      MAIL_MAILER: smtp
      MAIL_HOST: mailpit
      MAIL_PORT: 1025
      MAIL_USERNAME: null
      MAIL_PASSWORD: null
      MAIL_ENCRYPTION: null
      MAIL_FROM_ADDRESS: noreply@shiftpilot.com
      MAIL_FROM_NAME: ShiftPilot
    networks:
      - shiftpilot-network
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/api/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.localhost`)"
      - "traefik.http.routers.api.entrypoints=web"
      - "traefik.http.routers.api.middlewares=api-cors"
      - "traefik.http.services.api.loadbalancer.server.port=80"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowmethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowheaders=Content-Type,Accept,Authorization"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolalloworiginlist=http://frontend.localhost,http://localhost:3000"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.middlewares.api-cors.headers.addvaryheader=true"

  shiftpilot-frontend:
    build:
      context: ./shiftpilot-frontend
      dockerfile: Dockerfile
      args:
        - NODE_ENV=development
    container_name: shiftpilot-frontend
    restart: unless-stopped
    expose:
      - "3000"
    volumes:
      - ./shiftpilot-frontend:/app
      - /app/node_modules
      - /app/.next
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://api.localhost/api
      NEXT_PUBLIC_APP_URL: http://frontend.localhost
    networks:
      - shiftpilot-network
    depends_on:
      - shiftpilot-api
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`frontend.localhost`)"
      - "traefik.http.routers.frontend.entrypoints=web"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

  mailpit:
    image: axllent/mailpit
    container_name: shiftpilot-mailpit
    restart: unless-stopped
    expose:
      - "1025"
      - "8025"
    environment:
      MP_SMTP_AUTH_ACCEPT_ANY: 1
      MP_SMTP_AUTH_ALLOW_INSECURE: 1
    networks:
      - shiftpilot-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8025"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailpit.rule=Host(`mailpit.localhost`)"
      - "traefik.http.routers.mailpit.entrypoints=web"
      - "traefik.http.services.mailpit.loadbalancer.server.port=8025"

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: shiftpilot-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: rootpassword
      MYSQL_ROOT_PASSWORD: rootpassword
      UPLOAD_LIMIT: 100M
    networks:
      - shiftpilot-network
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.phpmyadmin.rule=Host(`db.localhost`)"
      - "traefik.http.routers.phpmyadmin.entrypoints=web"
      - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"
      # Removed auth middleware for easier development access

networks:
  shiftpilot-network:
    driver: bridge

volumes:
  mysql-data:
    driver: local
  redis-data:
    driver: local
